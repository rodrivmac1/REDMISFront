<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitud de Membresía</title>
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <link rel="stylesheet" href="css/login.css">
  <link rel="stylesheet" href="css/application_membership.css">
</head>
<body>
    <div id="sidebar"></div> 

    <div class="background"></div>
    <div class="title-container">Solicitud de Membresía</div>

    <div class="form-container">
      <div class="form-box" style="width: 700px;">
        <label>Tipo de Membresía</label>
        <select id="tipo-membresia" class="custom-select" required>
          <option value="" disabled selected>Selecciona una membresía</option>
        </select>

        <label>Teléfono</label>
        <input type="tel" id="telefono" class="custom-input" required>

        <label>Comentarios</label>
        <textarea id="comentarios" class="custom-textarea"></textarea>


        <label>CV (PDF)</label>
        <input type="file" id="cv-file" accept=".pdf" required>

        <button id="submit-membership" class="custom-button" type="button">Solicitar membresía</button>
      </div>
    </div>

    <script type="module">
      import membershipsService from './API/services/memberships.js';
      import membershipApplicationService from './API/services/membershipApplication.js';

      // Cargar tipos de membresía
      async function loadMemberships() {
          try {
              const response = await membershipsService.get();
              console.log('Respuesta del servicio:', response); // Para depuración
              
              // Manejar diferentes formatos de respuesta
              const memberships = Array.isArray(response) ? response : 
                                 (response.data ? response.data : []);
              
              if (!memberships.length) {
                  console.warn('No se recibieron membresías');
                  return;
              }

              const select = document.getElementById('tipo-membresia');
              
              // Limpiar opciones excepto la primera
              while(select.options.length > 1) {
                  select.remove(1);
              }

              // Agregar opciones de membresía
              memberships.forEach(membership => {
                  const option = document.createElement('option');
                  option.value = membership.id;
                  option.textContent = membership.nombre;
                  select.appendChild(option);
              });

          } catch (error) {
              console.error('Error al cargar membresías:', error);
              alert('No se pudieron cargar los tipos de membresía');
          }
      }

      function fileToBase64(file) {
          return new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.readAsDataURL(file);
              reader.onload = () => resolve(reader.result.split(',')[1]);
              reader.onerror = error => reject(error);
          });
      }
      async function submitMembership() {
          try {
              const membershipId = document.getElementById('tipo-membresia').value;
              const phone = document.getElementById('telefono').value;
              const comments = document.getElementById('comentarios').value;
              const cvFile = document.getElementById('cv-file').files[0];

              if (!membershipId || !phone || !cvFile) {
                  alert('Por favor complete todos los campos obligatorios');
                  return;
              }

              // Convertir el archivo a base64
              const cvBase64 = await fileToBase64(cvFile);
              const cvFileName = cvFile.name;

              // Crear el objeto con la estructura requerida
              const requestData = {
                  MR_Membresias_id: parseInt(membershipId),
                  telefono: phone,
                  comentarios: comments || '',
                  cv: cvFileName,
                  cv_base64: cvBase64 // Asumimos que el backend puede manejar base64
              };

              // Enviar la solicitud
              const response = await membershipApplicationService.solicitar(requestData);
              
              if (response.status === 'success') {
                  alert('Solicitud enviada exitosamente');
                  // Puedes redirigir o limpiar el formulario aquí
              } else {
                  alert('Error al enviar la solicitud: ' + (response.message || 'Error desconocido'));
              }

          } catch (error) {
              console.error('Error al enviar solicitud:', error);
              alert('Ocurrió un error al enviar la solicitud: ' + (error.message || 'Error desconocido'));
          }
      }

      // Cargar membresías al iniciar la página
      document.addEventListener('DOMContentLoaded', () => {
          loadMemberships();
          document.getElementById('submit-membership').addEventListener('click', submitMembership);
      });
    </script>

    <script type="module" src="js/verification.js"></script>
    <script type="module" src="js/sidebar.js"></script>
</body>
</html>