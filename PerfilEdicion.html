<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Perfil</title>
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/sidebar.css">
</head>
<body>
  <div id="sidebar"></div> 
  <div class="title-container">Perfil</div>

  <div class="form-container">
    <div class="form-box">
      <label>Nombre completo</label>
      <input id="nombre" type="text" placeholder="Nombre" disabled>
      <label>Género</label>
      <input id="genero" type="text" placeholder="Género" disabled>
      <label>Universidad</label>
      <select id="universidad" class="form-select" disabled>
        <!-- Las opciones se llenarán dinámicamente -->
      </select>
      <label>Estado</label>
      <input id="estado" type="text" placeholder="Estado" disabled>
    </div>
    <div class="form-box">
      <label>País</label>
      <input id="pais" type="text" placeholder="País" disabled>
      <label>Email</label>
      <input id="email" type="email" placeholder="Email" disabled>
      <label>Contraseña</label>
      <input id="password" type="password" placeholder="Contraseña" disabled>
    </div>
  </div>
  <div class="edit-button-container">
    <button class="edit-button" id="editBtn">Editar</button>
    <button class="edit-button" id="acceptBtn" style="display: none;">Aceptar</button>
    <button class="cancel-Btn" id="cancelBtn" style="display: none;">Cancelar</button>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script type="module">
    import membersService from './API/services/members.js';
    import loginService from './API/services/login.js';
    import universitiesService from './API/services/universities.js';

    // Get user data from loginService instead of localStorage directly
    const userData = loginService.getUserData();
    const userId = userData?.userId;
    const token = loginService.getToken();

    const fields = ['nombre', 'genero', 'universidad', 'estado', 'pais', 'email', 'password'];

    const enableFields = (enabled) => {
      fields.forEach(fieldId => {
        document.getElementById(fieldId).disabled = !enabled;
      });
    };

    const toggleButtons = (editing) => {
      document.getElementById('editBtn').style.display = editing ? 'none' : 'inline-block';
      document.getElementById('acceptBtn').style.display = editing ? 'inline-block' : 'none';
      document.getElementById('cancelBtn').style.display = editing ? 'inline-block' : 'none';
    };

    // Función mejorada para cargar universidades con manejo de errores
    const loadUniversities = async () => {
      try {
        console.log('Cargando universidades...'); // Debug
        const response = await universitiesService.get();
        console.log('Respuesta de universidades:', response); // Debug
        
        // Manejar diferentes formatos de respuesta
        const universities = response.data || response || [];
        console.log('Universidades procesadas:', universities); // Debug
        
        const select = document.getElementById('universidad');
        select.innerHTML = '<option value="">Selecciona una universidad</option>'; // Opción por defecto
        
        if (universities.length === 0) {
          console.warn('No se recibieron universidades');
          select.innerHTML = '<option value="">No hay universidades disponibles</option>';
          return;
        }
        
        universities.forEach(university => {
          const option = document.createElement('option');
          option.value = university.id || university.ID; // Variantes de nombre de campo
          option.textContent = university.nombre || university.Nombre || 'Universidad sin nombre';
          select.appendChild(option);
        });
        
        return universities; // Para uso posterior si es necesario
      } catch (error) {
        console.error('Error al cargar universidades:', error);
        const select = document.getElementById('universidad');
        select.innerHTML = '<option value="">Error al cargar universidades</option>';
        throw error;
      }
    };

    // Función para cargar datos del usuario
    const loadUserData = async () => {
      try {
        const user = await membersService.getbyID(userId);
        console.log('Datos del usuario:', user); // Debug
        
        document.getElementById('nombre').value = user.nombre_completo || '';
        document.getElementById('genero').value = user.genero || '';
        
        // Establecer la universidad seleccionada (maneja diferentes nombres de campo)
        if (user.universidad_id || user.universidadId) {
          document.getElementById('universidad').value = user.universidad_id || user.universidadId;
        }
        
        document.getElementById('estado').value = user.estado || '';
        document.getElementById('pais').value = user.pais || '';
        document.getElementById('email').value = user.email || '';
        document.getElementById('password').value = '********';
      } catch (error) {
        console.error('Error al cargar el perfil:', error);
        alert('No se pudo cargar la información del usuario.');
      }
    };

    // Carga inicial
    if (userId && token) {
      // Cargar universidades y luego datos del usuario
      loadUniversities()
        .then(() => loadUserData())
        .catch(error => console.error('Error en carga inicial:', error));
    } else {
      alert('Usuario no autenticado.');
      // window.location.href = 'login.html';
    }

    // Resto del código (event listeners) permanece igual
    document.getElementById('editBtn').addEventListener('click', () => {
      enableFields(true);
      toggleButtons(true);
      document.getElementById('password').value = '';
    });

    document.getElementById('acceptBtn').addEventListener('click', () => {
      let passwordInput = document.getElementById('password').value;
      let hashedPassword = passwordInput ? CryptoJS.MD5(passwordInput).toString() : "";
      
      const updatedUser = {
        nombre_completo: document.getElementById('nombre').value,
        genero: document.getElementById('genero').value,
        universidad_id: document.getElementById('universidad').value,
        estado: document.getElementById('estado').value,
        pais: document.getElementById('pais').value,
        email: document.getElementById('email').value,
        password: hashedPassword
      };

      if (passwordInput === '') delete updatedUser.password;

      membersService.updateMember(userId, updatedUser)
        .then(() => {
          alert('Perfil actualizado correctamente.');
          enableFields(false);
          toggleButtons(false);
          document.getElementById('password').value = '********';
        })
        .catch(error => {
          console.error('Error al actualizar el perfil:', error);
          alert('No se pudo actualizar el perfil.');
        });
    });

    document.getElementById('cancelBtn').addEventListener('click', () => {
      location.reload();
    });
  </script>

  <script>
    fetch('sidebar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('sidebar').innerHTML = html;
        const path = window.location.pathname.split('/').pop();
        const links = document.querySelectorAll('.sidebar-menu-item');
        links.forEach(link => {
          if (link.getAttribute('href') === path) {
            link.classList.add('active');
          }
        });
      });
  </script>
</body>
</html>